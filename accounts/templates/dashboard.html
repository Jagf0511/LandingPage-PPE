{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="dashboard-container">
    <h1>Dashboard</h1>
    
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search items...">
        <button id="searchButton">Search</button>
    </div>
    
    <button id="addButton">➕ Add New Item</button>
    
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Price</th>
                <th>Duration</th>
                <th>Location</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="resultsBody">
            <!-- Data will be loaded here -->
        </tbody>
    </table>
    
    <form action="{% url 'logout' %}" method="post">
        {% csrf_token %}
        <button type="submit" class="logout-btn">Logout</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Initialize Supabase (replace with your actual credentials)
    const supabaseUrl = 'YOUR_SUPABASE_URL';
    const supabaseKey = 'YOUR_SUPABASE_KEY';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Function to get all items
    async function getItems() {
        const { data, error } = await supabase
            .from("toures")
            .select("*");

        if (error) {
            console.error("Error fetching data:", error);
            return;
        }

        displayItems(data);
    }

    // Function to display items in the table
    function displayItems(items) {
        const tbody = document.getElementById("resultsBody");
        tbody.innerHTML = "";

        items.forEach(item => {
            const row = tbody.insertRow();
            row.insertCell().textContent = item.id;
            row.insertCell().textContent = item.nombre;
            row.insertCell().textContent = item.descripcion || "";
            row.insertCell().textContent = item.precio || "";
            row.insertCell().textContent = item.duracion || "";
            row.insertCell().textContent = item.ubicacion || "";
            
            const actionsCell = row.insertCell();
            actionsCell.className = "action-buttons";
            
            const editBtn = document.createElement("button");
            editBtn.textContent = "✏️ Edit";
            editBtn.className = "edit-btn";
            editBtn.onclick = () => editItem(item.id);
            
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "❌ Delete";
            deleteBtn.className = "delete-btn";
            deleteBtn.onclick = () => deleteItem(item.id);
            
            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(deleteBtn);
        });
    }

    // Function to add a new item
    async function addItem() {
        const nombre = prompt("Enter the name of the new item:");
        if (!nombre) return;

        const { data, error } = await supabase
            .from("toures")
            .insert([{ nombre }]);

        if (error) {
            console.error("Error adding item:", error);
            alert("Failed to add item");
        } else {
            alert("Item added successfully");
            getItems();
        }
    }

    // Function to edit an item
    async function editItem(id) {
        const { data, error } = await supabase
            .from("toures")
            .select("*")
            .eq("id", id)
            .single();

        if (error) {
            console.error("Error fetching item:", error);
            return;
        }

        const newName = prompt("Edit item name:", data.nombre);
        if (!newName) return;

        const { error: updateError } = await supabase
            .from("toures")
            .update({ nombre: newName })
            .eq("id", id);

        if (updateError) {
            console.error("Error updating item:", updateError);
            alert("Failed to update item");
        } else {
            alert("Item updated successfully");
            getItems();
        }
    }

    // Function to delete an item
    async function deleteItem(id) {
        if (!confirm("Are you sure you want to delete this item?")) return;

        const { error } = await supabase
            .from("toures")
            .delete()
            .eq("id", id);

        if (error) {
            console.error("Error deleting item:", error);
            alert("Failed to delete item");
        } else {
            alert("Item deleted successfully");
            getItems();
        }
    }

    // Search functionality
    document.getElementById("searchButton").addEventListener("click", async function() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        
        const { data, error } = await supabase
            .from("toures")
            .select("*");

        if (error) {
            console.error("Error searching:", error);
            return;
        }

        const filteredData = data.filter(item => 
            item.nombre.toLowerCase().includes(searchTerm) || 
            (item.descripcion && item.descripcion.toLowerCase().includes(searchTerm))
        );

        displayItems(filteredData);
    });

    // Add button event listener
    document.getElementById("addButton").addEventListener("click", addItem);

    // Load items when page loads
    document.addEventListener("DOMContentLoaded", getItems);
</script>
{% endblock %}
